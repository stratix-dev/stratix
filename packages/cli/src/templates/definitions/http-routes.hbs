import { FastifyHTTPPlugin, type HttpRequest, type HttpResponse } from '@stratix/http-fastify';
import type { CommandBus, QueryBus, Result } from '@stratix/core';
import { Create{{entityName}}, type Create{{entityName}}Command } from '../../application/commands/Create{{entityName}}.js';
import { Get{{entityName}}ById } from '../../application/queries/Get{{entityName}}ById.js';
import { List{{entityName}}s } from '../../application/queries/List{{entityName}}s.js';

const basePath = '/{{entityNameLowercase}}s';
type {{entityName}}Params = { id: string };

class Create{{entityName}}Route {
  readonly method = 'POST';
  readonly path = basePath;

  constructor(private readonly commandBus: CommandBus) {}

  async handle(request: HttpRequest<Create{{entityName}}Command>): Promise<HttpResponse> {
    const command = new Create{{entityName}}(request.body);

    const result = await this.commandBus.dispatch<Result<unknown, Error>>(command);

    if (result.isFailure) {
      return {
        statusCode: 400,
        body: { error: result.error.message }
      };
    }

    return {
      statusCode: 201,
      body: result.value
    };
  }
}

class Get{{entityName}}ByIdRoute {
  readonly method = 'GET';
  readonly path = `${basePath}/:id`;

  constructor(private readonly queryBus: QueryBus) {}

  async handle(request: HttpRequest<unknown, unknown, {{entityName}}Params>): Promise<HttpResponse> {
    const { id } = request.params;
    const query = new Get{{entityName}}ById({ id });
    const result = await this.queryBus.execute<Result<unknown, Error>>(query);

    if (result.isFailure) {
      return {
        statusCode: 404,
        body: { error: 'Not found' }
      };
    }

    return {
      statusCode: 200,
      body: result.value
    };
  }
}

class List{{entityName}}sRoute {
  readonly method = 'GET';
  readonly path = basePath;

  constructor(private readonly queryBus: QueryBus) {}

  async handle(): Promise<HttpResponse> {
    const query = new List{{entityName}}s({});
    const result = await this.queryBus.execute<Result<unknown, Error>>(query);

    if (result.isFailure) {
      return {
        statusCode: 500,
        body: { error: result.error.message }
      };
    }

    return {
      statusCode: 200,
      body: result.value || []
    };
  }
}

/**
 * Register HTTP routes for {{entityName}} context using class-based routes.
 *
 * @param http - Fastify HTTP plugin instance
 * @param commandBus - Command bus for executing commands
 * @param queryBus - Query bus for executing queries
 */
export function register{{entityName}}Routes(
  http: FastifyHTTPPlugin,
  commandBus: CommandBus,
  queryBus: QueryBus
): void {
  http.routeClass(new Create{{entityName}}Route(commandBus));
  http.routeClass(new Get{{entityName}}ByIdRoute(queryBus));
  http.routeClass(new List{{entityName}}sRoute(queryBus));
}
