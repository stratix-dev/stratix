import { FastifyHTTPPlugin } from '@stratix/http-fastify';
import { CommandBus, QueryBus } from '@stratix/core';
import { Create{{entityName}}Command } from '../../application/commands/Create{{entityName}}.js';
import { Get{{entityName}}ByIdQuery } from '../../application/queries/Get{{entityName}}ById.js';
import { List{{entityName}}sQuery } from '../../application/queries/List{{entityName}}s.js';

/**
 * Register HTTP routes for {{entityName}} context
 * 
 * @param http - Fastify HTTP plugin instance
 * @param commandBus - Command bus for executing commands
 * @param queryBus - Query bus for executing queries
 */
export function register{{entityName}}Routes(
  http: FastifyHTTPPlugin,
  commandBus: CommandBus,
  queryBus: QueryBus
): void {
  const basePath = '/{{entityNameLowercase}}s';

  // POST {{basePath}} - Create {{entityName}}
  http.post(basePath, async (request) => {
    const body = request.body as any;
    
    const command = new Create{{entityName}}Command(
      {{#each props}}
      body.{{name}}{{#unless @last}},{{/unless}}
      {{/each}}
    );
    
    const result = await commandBus.dispatch(command);
    
    if (result.isFailure) {
      return {
        statusCode: 400,
        body: { error: result.error.message }
      };
    }
    
    return {
      statusCode: 201,
      body: result.value
    };
  });

  // GET {{basePath}}/:id - Get {{entityName}} by ID
  http.get(`${basePath}/:id`, async (request) => {
    const { id } = request.params as { id: string };
    
    const query = new Get{{entityName}}ByIdQuery(id);
    const result = await queryBus.execute(query);
    
    if (result.isFailure) {
      return {
        statusCode: 404,
        body: { error: 'Not found' }
      };
    }
    
    return {
      statusCode: 200,
      body: result.value
    };
  });

  // GET {{basePath}} - List all {{entityName}}s
  http.get(basePath, async (request) => {
    const query = new List{{entityName}}sQuery();
    const result = await queryBus.execute(query);
    
    if (result.isFailure) {
      return {
        statusCode: 500,
        body: { error: result.error.message }
      };
    }
    
    return {
      statusCode: 200,
      body: result.value || []
    };
  });
}
