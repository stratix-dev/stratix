name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build all packages
        run: pnpm -r --filter '!website' build

      - name: Run tests
        run: pnpm test
        env:
          CI: true

      - name: Extract version from tag
        id: version
        run: |
          if [[ "${GITHUB_REF}" =~ ^refs/tags/v(.*)$ ]]; then
            echo "version=${BASH_REMATCH[1]}" >> $GITHUB_OUTPUT
          else
            echo "version=latest" >> $GITHUB_OUTPUT
          fi

      - name: Generate changelog
        id: changelog
        run: |
          # Generate changelog from commits
          if git describe --tags --abbrev=0 HEAD^ >/dev/null 2>&1; then
            previous_tag=$(git describe --tags --abbrev=0 HEAD^)
            echo "Generating changelog from $previous_tag to HEAD"
            changelog=$(git log ${previous_tag}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          else
            echo "No previous tag found, generating full changelog"
            changelog=$(git log --pretty=format:"- %s (%h)" --no-merges)
          fi

          # Save to file for multiline handling
          echo "$changelog" > changelog.txt

      - name: Create package summary
        id: packages
        run: |
          echo "## Packages" > packages.md
          echo "" >> packages.md
          
          # Core packages
          for pkg in packages/core packages/runtime packages/testing; do
            if [ -f "$pkg/package.json" ]; then
              name=$(node -p "require('./$pkg/package.json').name")
              version=$(node -p "require('./$pkg/package.json').version")
              description=$(node -p "require('./$pkg/package.json').description || 'No description'")
              echo "### \`$name@$version\`" >> packages.md
              echo "" >> packages.md
              echo "$description" >> packages.md
              echo "" >> packages.md
            fi
          done
          
          # AI providers
          for pkg in packages/ai/providers/*; do
            if [ -f "$pkg/package.json" ]; then
              name=$(node -p "require('./$pkg/package.json').name")
              version=$(node -p "require('./$pkg/package.json').version")
              description=$(node -p "require('./$pkg/package.json').description || 'No description'")
              echo "### \`$name@$version\`" >> packages.md
              echo "" >> packages.md
              echo "$description" >> packages.md
              echo "" >> packages.md
            fi
          done
          
          # Provider packages
          for category in packages/providers/*; do
            if [ -d "$category" ]; then
              for pkg in "$category"/*; do
                if [ -f "$pkg/package.json" ]; then
                  name=$(node -p "require('./$pkg/package.json').name")
                  version=$(node -p "require('./$pkg/package.json').version")
                  description=$(node -p "require('./$pkg/package.json').description || 'No description'")
                  echo "### \`$name@$version\`" >> packages.md
                  echo "" >> packages.md
                  echo "$description" >> packages.md
                  echo "" >> packages.md
                fi
              done
            fi
          done

      - name: Create release body
        run: |
          cat > release_body.md << 'EOF'
          ## What's Changed

          EOF
          cat changelog.txt >> release_body.md
          cat >> release_body.md << 'EOF'

          EOF
          cat packages.md >> release_body.md
          cat >> release_body.md << EOF

          ## Installation

          \`\`\`bash
          npm install @stratix/core@${{ steps.version.outputs.version }}
          npm install @stratix/runtime@${{ steps.version.outputs.version }}
          npm install @stratix/testing@${{ steps.version.outputs.version }}
          \`\`\`

          ## Full Changelog

          https://github.com/${{ github.repository }}/compare/v0.0.0...v${{ steps.version.outputs.version }}
          EOF

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ steps.version.outputs.version }}
          body_path: release_body.md
          draft: false
          prerelease: ${{ contains(steps.version.outputs.version, 'alpha') || contains(steps.version.outputs.version, 'beta') || contains(steps.version.outputs.version, 'rc') }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment on related issues
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ steps.version.outputs.version }}';

            // Find issues mentioned in commits
            const commits = await github.rest.repos.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.sha,
              per_page: 100
            });

            const issueNumbers = new Set();
            commits.data.forEach(commit => {
              const matches = commit.commit.message.match(/#(\d+)/g);
              if (matches) {
                matches.forEach(match => {
                  issueNumbers.add(parseInt(match.substring(1)));
                });
              }
            });

            // Comment on each issue
            for (const issueNumber of issueNumbers) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `This issue has been addressed in release [v${version}](https://github.com/${context.repo.owner}/${context.repo.repo}/releases/tag/v${version}).`
              });
            }
