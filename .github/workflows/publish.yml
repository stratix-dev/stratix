name: Publish to npm

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to publish (leave empty for latest)'
        required: false
        type: string

jobs:
  publish:
    name: Publish to npm
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build all packages
        run: pnpm -r --filter '!website' build

      - name: Run tests
        run: pnpm test
        env:
          CI: true

      - name: Verify package contents
        run: |
          echo "Verifying package contents..."

          # Function to verify a package
          verify_package() {
            local pkg_dir=$1
            if [ -f "$pkg_dir/package.json" ]; then
              echo "=== Verifying: $pkg_dir ==="
              cd "$pkg_dir"

              # Check for required files
              if [ ! -f "dist/index.js" ] && [ ! -f "dist/index.d.ts" ]; then
                echo "Warning: Missing dist files in $pkg_dir"
              fi

              if [ ! -f "README.md" ]; then
                echo "Warning: Missing README.md in $pkg_dir"
              fi

              # Show package.json info
              echo "Name: $(node -p "require('./package.json').name")"
              echo "Version: $(node -p "require('./package.json').version")"

              cd - > /dev/null
            fi
          }

          # Verify core packages
          verify_package "packages/core"
          verify_package "packages/runtime"
          verify_package "packages/cli"
          verify_package "packages/testing"

          # Verify plugin packages
          for category in packages/plugins/*; do
            if [ -d "$category" ]; then
              for plugin in "$category"/*; do
                if [ -d "$plugin" ]; then
                  verify_package "$plugin"
                fi
              done
            fi
          done

      - name: Publish packages
        run: |
          set -e  # Exit on any error
          
          # Configure npm authentication
          echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" > ~/.npmrc

          # Track published packages
          PUBLISHED_PACKAGES=()
          FAILED_PACKAGES=()

          # Function to publish a package
          publish_package() {
            local pkg_dir=$1
            local original_dir=$(pwd)
            
            if [ ! -f "$pkg_dir/package.json" ]; then
              echo "âš ï¸  No package.json found in $pkg_dir, skipping..."
              return 0
            fi

            echo "ðŸ“¦ Processing $pkg_dir..."
            cd "$pkg_dir" || {
              echo "âŒ Failed to change directory to $pkg_dir"
              FAILED_PACKAGES+=("$pkg_dir (cd failed)")
              cd "$original_dir"
              return 1
            }

            # Check if package is private
            local is_private=$(node -p "require('./package.json').private || false")
            if [ "$is_private" = "true" ]; then
              echo "â­ï¸  Skipping private package: $pkg_dir"
              cd "$original_dir"
              return 0
            fi

            # Get package name and version
            local pkg_name=$(node -p "require('./package.json').name")
            local pkg_version=$(node -p "require('./package.json').version")

            # Check if this version is already published
            if npm view "$pkg_name@$pkg_version" version 2>/dev/null; then
              echo "âœ“ Version $pkg_version of $pkg_name is already published, skipping..."
              cd "$original_dir"
              return 0
            fi

            echo "ðŸš€ Publishing $pkg_name@$pkg_version..."

            # Publish to npm with error handling
            if npm publish --access public 2>&1; then
              echo "âœ… Successfully published $pkg_name@$pkg_version"
              PUBLISHED_PACKAGES+=("$pkg_name@$pkg_version")
              cd "$original_dir"
              return 0
            else
              local exit_code=$?
              echo "âŒ Failed to publish $pkg_name@$pkg_version (exit code: $exit_code)"
              FAILED_PACKAGES+=("$pkg_name@$pkg_version")
              cd "$original_dir"
              return 1
            fi
          }

          echo "========================================="
          echo "Starting package publication process"
          echo "========================================="
          echo ""

          # Publish in dependency order
          # 1. Core packages (no dependencies)
          publish_package "packages/core" || true

          # 2. Runtime (depends on core)
          publish_package "packages/runtime" || true

          # 3. Plugins (depend on core and/or runtime)
          # Database plugins
          publish_package "packages/plugins/database/postgres" || true
          publish_package "packages/plugins/database/mongodb" || true
          publish_package "packages/plugins/database/redis" || true

          # HTTP plugins
          publish_package "packages/plugins/http/client" || true
          publish_package "packages/plugins/http/fastify" || true

          # Messaging plugins
          publish_package "packages/plugins/messaging/rabbitmq" || true

          # Observability plugins
          publish_package "packages/plugins/observability/opentelemetry" || true

          # Utility plugins
          publish_package "packages/libraries/errors" || true
          
          # Security plugins
          publish_package "packages/plugins/security/auth" || true
          publish_package "packages/plugins/security/secrets" || true

          # Providers
          publish_package "packages/providers/di/awilix" || true
          publish_package "packages/providers/ai/openai" || true
          publish_package "packages/providers/ai/anthropic" || true
          publish_package "packages/providers/validation/zod" || true

          # 4. Testing utilities (depend on core, runtime, di)
          publish_package "packages/testing" || true

          # 5. CLI tools (depend on core)
          publish_package "packages/cli" || true

          echo ""
          echo "========================================="
          echo "Publication Summary"
          echo "========================================="
          echo ""
          
          if [ ${#PUBLISHED_PACKAGES[@]} -gt 0 ]; then
            echo "âœ… Successfully published (${#PUBLISHED_PACKAGES[@]} packages):"
            for pkg in "${PUBLISHED_PACKAGES[@]}"; do
              echo "  - $pkg"
            done
            echo ""
          fi

          if [ ${#FAILED_PACKAGES[@]} -gt 0 ]; then
            echo "âŒ Failed to publish (${#FAILED_PACKAGES[@]} packages):"
            for pkg in "${FAILED_PACKAGES[@]}"; do
              echo "  - $pkg"
            done
            echo ""
            echo "âš ï¸  Some packages failed to publish. Please check the logs above."
            exit 1
          fi

          if [ ${#PUBLISHED_PACKAGES[@]} -eq 0 ] && [ ${#FAILED_PACKAGES[@]} -eq 0 ]; then
            echo "â„¹ï¸  No new packages to publish (all versions already published)"
          fi

        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Create publish summary
        if: success()
        run: |
          echo "## Published Packages" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Function to add package to summary
          add_to_summary() {
            local pkg_dir=$1
            if [ -f "$pkg_dir/package.json" ]; then
              local name=$(node -p "require('./$pkg_dir/package.json').name")
              local version=$(node -p "require('./$pkg_dir/package.json').version")
              echo "- \`$name@$version\`" >> $GITHUB_STEP_SUMMARY
            fi
          }

          echo "### Core" >> $GITHUB_STEP_SUMMARY
          add_to_summary "packages/core"
          add_to_summary "packages/runtime"

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Database Plugins" >> $GITHUB_STEP_SUMMARY
          add_to_summary "packages/plugins/database/postgres"
          add_to_summary "packages/plugins/database/mongodb"
          add_to_summary "packages/plugins/database/redis"

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### HTTP Plugins" >> $GITHUB_STEP_SUMMARY
          add_to_summary "packages/plugins/http/client"
          add_to_summary "packages/plugins/http/fastify"

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Messaging Plugins" >> $GITHUB_STEP_SUMMARY
          add_to_summary "packages/plugins/messaging/rabbitmq"

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Observability Plugins" >> $GITHUB_STEP_SUMMARY
          add_to_summary "packages/plugins/observability/opentelemetry"

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Utility Plugins" >> $GITHUB_STEP_SUMMARY
          add_to_summary "packages/libraries/errors"

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Security Plugins" >> $GITHUB_STEP_SUMMARY
          add_to_summary "packages/plugins/security/auth"
          add_to_summary "packages/plugins/security/secrets"

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Providers" >> $GITHUB_STEP_SUMMARY
          add_to_summary "packages/providers/di/awilix"
          add_to_summary "packages/providers/ai/openai"
          add_to_summary "packages/providers/ai/anthropic"
          add_to_summary "packages/providers/validation/zod"

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Tools" >> $GITHUB_STEP_SUMMARY
          add_to_summary "packages/testing"
          add_to_summary "packages/cli"

      - name: Notify on failure
        if: failure()
        run: |
          echo "## Publish Failed" >> $GITHUB_STEP_SUMMARY
          echo "Check the logs for details." >> $GITHUB_STEP_SUMMARY
