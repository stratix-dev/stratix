name: Publish to npm

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to publish (leave empty for latest)'
        required: false
        type: string

jobs:
  publish:
    name: Publish to npm
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build all packages
        run: pnpm -r --filter '!website' build

      - name: Run tests
        run: pnpm test
        env:
          CI: true

      - name: Verify package contents
        run: |
          echo "Verifying package contents..."

          # Function to verify a package
          verify_package() {
            local pkg_dir=$1
            if [ -f "$pkg_dir/package.json" ]; then
              echo "=== Verifying: $pkg_dir ==="
              cd "$pkg_dir"

              # Check for required files
              if [ ! -f "dist/index.js" ] && [ ! -f "dist/index.d.ts" ]; then
                echo "Warning: Missing dist files in $pkg_dir"
              fi

              if [ ! -f "README.md" ]; then
                echo "Warning: Missing README.md in $pkg_dir"
              fi

              # Show package.json info
              echo "Name: $(node -p "require('./package.json').name")"
              echo "Version: $(node -p "require('./package.json').version")"

              cd - > /dev/null
            fi
          }

          # Verify core packages
          verify_package "packages/core"
          verify_package "packages/runtime"
          verify_package "packages/cli"
          verify_package "packages/testing"

          # Verify plugin packages
          for category in packages/plugins/*; do
            if [ -d "$category" ]; then
              for plugin in "$category"/*; do
                if [ -d "$plugin" ]; then
                  verify_package "$plugin"
                fi
              done
            fi
          done

      - name: Publish packages
        run: |
          # Configure npm authentication
          echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" > ~/.npmrc

          # Function to publish a package
          publish_package() {
            local pkg_dir=$1
            if [ -f "$pkg_dir/package.json" ]; then
              echo "Publishing $pkg_dir..."
              cd "$pkg_dir"

              # Check if package is private
              if [ "$(node -p "require('./package.json').private || false")" = "true" ]; then
                echo "Skipping private package: $pkg_dir"
                cd - > /dev/null
                return
              fi

              # Get package name and version
              PKG_NAME=$(node -p "require('./package.json').name")
              PKG_VERSION=$(node -p "require('./package.json').version")

              # Check if this version is already published
              if npm view "$PKG_NAME@$PKG_VERSION" version 2>/dev/null; then
                echo "Version $PKG_VERSION of $PKG_NAME is already published, skipping..."
                cd - > /dev/null
                return
              fi

              echo "Publishing $PKG_NAME@$PKG_VERSION..."

              echo "Successfully published $PKG_NAME@$PKG_VERSION"
              cd - > /dev/null
            fi
          }

          # Publish in dependency order
          # 1. Core packages (no dependencies)
          publish_package "packages/core"

          # 2. Runtime (depends on core)
          publish_package "packages/runtime"

          # 3. Plugins (depend on core and/or runtime)
          # Database plugins
          publish_package "packages/plugins/database/postgres"
          publish_package "packages/plugins/database/mongodb"
          publish_package "packages/plugins/database/redis"

          # DI plugins
          publish_package "packages/plugins/di/awilix"

          # HTTP plugins
          publish_package "packages/plugins/http/fastify"

          # AI plugins
          publish_package "packages/plugins/ai/openai"
          publish_package "packages/plugins/ai/anthropic"

          # Messaging plugins
          publish_package "packages/plugins/messaging/rabbitmq"

          # Observability plugins
          publish_package "packages/plugins/observability/opentelemetry"

          # Utility plugins
          publish_package "packages/plugins/utilities/auth"
          publish_package "packages/plugins/utilities/validation-zod"
          publish_package "packages/plugins/utilities/mappers"
          publish_package "packages/plugins/utilities/errors"
          publish_package "packages/plugins/utilities/secrets"

          # 4. Testing utilities (depend on core, runtime, di)
          publish_package "packages/testing"

          # 5. CLI tools (depend on core)
          publish_package "packages/cli"

        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Create publish summary
        if: success()
        run: |
          echo "## Published Packages" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Function to add package to summary
          add_to_summary() {
            local pkg_dir=$1
            if [ -f "$pkg_dir/package.json" ]; then
              local name=$(node -p "require('./$pkg_dir/package.json').name")
              local version=$(node -p "require('./$pkg_dir/package.json').version")
              echo "- \`$name@$version\`" >> $GITHUB_STEP_SUMMARY
            fi
          }

          echo "### Core" >> $GITHUB_STEP_SUMMARY
          add_to_summary "packages/core"
          add_to_summary "packages/runtime"

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Database Plugins" >> $GITHUB_STEP_SUMMARY
          add_to_summary "packages/plugins/database/postgres"
          add_to_summary "packages/plugins/database/mongodb"
          add_to_summary "packages/plugins/database/redis"

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### DI Plugins" >> $GITHUB_STEP_SUMMARY
          add_to_summary "packages/plugins/di/awilix"

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### HTTP Plugins" >> $GITHUB_STEP_SUMMARY
          add_to_summary "packages/plugins/http/fastify"

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### AI Plugins" >> $GITHUB_STEP_SUMMARY
          add_to_summary "packages/plugins/ai/openai"
          add_to_summary "packages/plugins/ai/anthropic"

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Messaging Plugins" >> $GITHUB_STEP_SUMMARY
          add_to_summary "packages/plugins/messaging/rabbitmq"

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Observability Plugins" >> $GITHUB_STEP_SUMMARY
          add_to_summary "packages/plugins/observability/opentelemetry"

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Utility Plugins" >> $GITHUB_STEP_SUMMARY
          add_to_summary "packages/plugins/utilities/auth"
          add_to_summary "packages/plugins/utilities/validation-zod"
          add_to_summary "packages/plugins/utilities/mappers"
          add_to_summary "packages/plugins/utilities/errors"
          add_to_summary "packages/plugins/utilities/secrets"

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Tools" >> $GITHUB_STEP_SUMMARY
          add_to_summary "packages/testing"
          add_to_summary "packages/cli"

      - name: Notify on failure
        if: failure()
        run: |
          echo "## Publish Failed" >> $GITHUB_STEP_SUMMARY
          echo "Check the logs for details." >> $GITHUB_STEP_SUMMARY
